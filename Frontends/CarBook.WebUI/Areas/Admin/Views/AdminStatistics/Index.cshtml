@{
    ViewData["Title"] = "İstatistikler";
    Layout = "~/Views/AdminLayout/Index.cshtml";
}

<script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card bg-primary border-primary">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Aktif Araçlar</span>
                            <h5 class="card-title mb-0 text-white">Araç Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center mb-0 text-white" id="carcount">@ViewBag.CarCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-success border-success">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Aktif Lokasyonlar</span>
                            <h5 class="card-title mb-0 text-white">Lokasyon Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="locationcount">@ViewBag.LocationCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-warning border-warning">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Aktif Yazarlar</span>
                            <h5 class="card-title mb-0 text-white">Yazar Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="authorcount">@ViewBag.AuthorCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-info border-info">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Tüm Zamanlar</span>
                            <h5 class="card-title mb-0 text-white">Blog Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="blogcount">@ViewBag.BlogCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card bg-primary border-primary">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Tüm Araçlar</span>
                            <h5 class="card-title mb-0 text-white">Marka Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center mb-0 text-white" id="brandcount">@ViewBag.BrandCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-success border-success">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Saatlik</span>
                            <h5 class="card-title mb-0 text-white">Ort. Kiralama Fiyatı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="avgHourlyCount">₺ @ViewBag.AvgHourlyCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-warning border-warning">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Günlük</span>
                            <h5 class="card-title mb-0 text-white">Ort. Kiralama Fiyatı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="avgDailyCount">₺ @ViewBag.AvgDailyCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-info border-info">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Haftalık</span>
                            <h5 class="card-title mb-0 text-white">Ort. Kiralama Fiyatı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="avgWeeklyCount">₺ @ViewBag.AvgWeeklyCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card bg-primary border-primary">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Otomatik Vites</span>
                            <h5 class="card-title mb-0 text-white">Araç Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center mb-0 text-white" id="autocount">@ViewBag.AutoCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-success border-success">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">En Çok Araçlı</span>
                            <h5 class="card-title mb-0 text-white">Marka</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center mb-0 text-white" id="mostbrand">@ViewBag.MostBrand</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-warning border-warning">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">En Çok Yorumlu</span>
                            <h5 class="card-title mb-0 text-white">Blog</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h5 class="d-flex align-items-center text-white mb-0" id="mostblog">@ViewBag.MostBlog</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-info border-info">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">30.000 Km Altı</span>
                            <h5 class="card-title mb-0 text-white">Araç Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="carcountbykm">@ViewBag.CarCountByKm</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card bg-primary border-primary">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Benzin</span>
                            <h5 class="card-title mb-0 text-white">Araç Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center mb-0 text-white" id="gasolinecount">@ViewBag.CarCountGasoline</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-success border-success">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Dizel</span>
                            <h5 class="card-title mb-0 text-white">Araç Sayısı</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h2 class="d-flex align-items-center text-white mb-0" id="dieselcount">@ViewBag.CarCountDiesel</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-warning border-warning">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Günlük Kiralama</span>
                            <h5 class="card-title mb-0 text-white">En Pahalı Araç</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h4 class="d-flex align-items-center text-white mb-0" id="carmaxprice">
                                    @ViewBag.CarBrandMax - @ViewBag.CarModelMax
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card bg-info border-info">
                    <div class="card-body">
                        <div class="mb-4">
                            <span class="badge badge-soft-light float-right">Günlük Kiralama</span>
                            <h5 class="card-title mb-0 text-white">En Ucuz Araç</h5>
                        </div>
                        <div class="row d-flex align-items-center mb-4">
                            <div class="col-8">
                                <h4 class="d-flex align-items-center text-white mb-0" id="carminprice">
                                    @ViewBag.CarBrandMin - @ViewBag.CarModelMin
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(() => {
            var connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7131/statisticshub")
                .withAutomaticReconnect()
                .build();

            connection.start().then(() => {
                console.log("SignalR: Bağlantı Başarılı.");
            }).catch((err) => console.error(err));

            // --- 1. Statik Rakam Güncellemeleri (Value bazlı) ---
            connection.on("ReceiveCarCount", (val) => { updateVal("#carcount", val); });
            connection.on("ReceiveLocationCount", (val) => { updateVal("#locationcount", val); });
            connection.on("ReceiveAuthorCount", (val) => { updateVal("#authorcount", val); });
            connection.on("ReceiveBlogCount", (val) => { updateVal("#blogcount", val); });
            connection.on("ReceiveBrandCount", (val) => { updateVal("#brandcount", val); });

            // --- 2. Dinamik Bildirim Güncellemeleri (AJAX bazlı) ---

            // Ortalama Fiyatlar
            connection.on("ReceiveCarPricingUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetUpdatedPricing?type=Saatlik", (d) => "₺ " + parseFloat(JSON.parse(d).avaragePrice).toFixed(2), "#avgHourlyCount");
                fetchAjax("/Admin/AdminStatistics/GetUpdatedPricing?type=Günlük", (d) => "₺ " + parseFloat(JSON.parse(d).avaragePrice).toFixed(2), "#avgDailyCount");
                fetchAjax("/Admin/AdminStatistics/GetUpdatedPricing?type=Haftalık", (d) => "₺ " + parseFloat(JSON.parse(d).avaragePrice).toFixed(2), "#avgWeeklyCount");
            });

            // Otomatik Vites Sayısı
            connection.on("ReceiveAutomaticCarCountUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetAutomaticCarCount", (d) => JSON.parse(d).carCount, "#autocount");
            });

            // En Çok Araca Sahip Marka
            connection.on("ReceiveMostBrandUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetMostBrandWithCar", (d) => JSON.parse(d).brandName, "#mostbrand");
            });

            // En Çok Yorumlu Blog
            connection.on("ReceiveMostBlogWithCommentUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetMostBlogWithComment", (d) => JSON.parse(d).blogTitle, "#mostblog");
            });

            // Km Bazlı Sayım (30k altı)
            connection.on("ReceiveCarCountByKmUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetCarCountByKm", (d) => JSON.parse(d).carCount, "#carcountbykm");
            });

            // Yakıt Bazlı Sayımlar
            connection.on("CarCountByFuelUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetCarCountByFuel?fuel=Benzin", (d) => JSON.parse(d).carCount, "#gasolinecount");
                fetchAjax("/Admin/AdminStatistics/GetCarCountByFuel?fuel=Dizel", (d) => JSON.parse(d).carCount, "#dieselcount");
            });

            // Max/Min Fiyatlı Modeller
            connection.on("ReceiveCarModelAndBrandMaxDailyPriceUpdateNotification", () => {
                fetchAjax("/Admin/AdminStatistics/GetCarModelAndBrandMaxOrMinDailyPrice?check=true", (d) => { let j = JSON.parse(d); return j.brand + " - " + j.model; }, "#carmaxprice");
                fetchAjax("/Admin/AdminStatistics/GetCarModelAndBrandMaxOrMinDailyPrice?check=false", (d) => { let j = JSON.parse(d); return j.brand + " - " + j.model; }, "#carminprice");
            });

            // --- Yardımcı Fonksiyonlar ---
            function updateVal(id, val) {
                $(id).fadeOut(200, function() { $(this).text(val).fadeIn(200); });
            }

            function fetchAjax(url, parseFunc, elementId) {
                $.get(url, (data) => {
                    const finalVal = parseFunc(data);
                    $(elementId).fadeOut(200, function() { $(this).text(finalVal).fadeIn(200); });
                });
            }
        });
    </script>
}